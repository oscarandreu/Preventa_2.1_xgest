CREATE DATABASE 'C:\work\pockectPC\Preventa\bbdd\DATABASE.FDB' page_size 8192
user 'SYSDBA' password 'masterkey';

CONNECT "C:\work\pockectPC\Preventa\bbdd\DATABASE.FDB"
user 'SYSDBA' password 'masterkey';


CREATE TABLE AGENTES (
	CODIGO		INTEGER 	NOT NULL PRIMARY KEY,
	SERIE		VARCHAR(5)	NOT NULL UNIQUE,
	NOMBRE		VARCHAR(40),
	PASSW		VARCHAR(10)
);

CREATE TABLE PPC (
	id 		varchar(8) 	NOT NULL PRIMARY KEY,
	codigo_agente 	INTEGER,
	marca 		varchar(20),
	distribuidor	varchar(20),
	garantia	varchar(20),
	fecha_compra	date,
	modelo 		varchar(20),
	observaciones 	varchar(50),
	actualiz_clientes	TIMESTAMP,
	actualiz_articulos	TIMESTAMP
);

CREATE TABLE TIPOS(
	CODIGO		VARCHAR(5) 	NOT NULL PRIMARY KEY,
	DESCRIPCION	VARCHAR(30)
);


CREATE TABLE ACTIVIDADES(
	CODIGO		VARCHAR(5) 	NOT NULL PRIMARY KEY,
	DESCRIPCION	VARCHAR(30)
);

CREATE TABLE FAMILIAS(
	CODIGO		VARCHAR(5) 	NOT NULL PRIMARY KEY,
	DESCRIPCION	VARCHAR(30)
);

CREATE TABLE RUTAS(
	CODIGO		VARCHAR(5)	 NOT NULL PRIMARY KEY,
	DESCRIPCION	VARCHAR(30)
);

CREATE TABLE SECCIONES(
	CODIGO		VARCHAR(5) 	NOT NULL PRIMARY KEY,
	DESCRIPCION	VARCHAR(30)
);

CREATE TABLE SUBFAMILIAS(
	CODIGO		VARCHAR(5) 	NOT NULL PRIMARY KEY,
	DESCRIPCION	VARCHAR(30)
);

CREATE TABLE TIPOS_INCIDENCIAS(
	CODIGO		VARCHAR(5) 	NOT NULL PRIMARY KEY,
	DESCRIPCION	VARCHAR(30)
);

CREATE TABLE ZONAS(
	CODIGO		VARCHAR(5) 	NOT NULL PRIMARY KEY,
	DESCRIPCION	VARCHAR(30)
);


CREATE TABLE PAISES(
	CODIGO		CHAR(5) 	NOT NULL PRIMARY KEY,
	DESCRIPCION	VARCHAR(30)
);


CREATE TABLE DIVISAS(
	CODIGO		VARCHAR(3) 	NOT NULL PRIMARY KEY,
	DESCRIPCION	VARCHAR(30)
);


CREATE TABLE FORMAS_PAGO(
	CODIGO		VARCHAR(5)	 NOT NULL PRIMARY KEY,
	NOMBRE		VARCHAR(50),
	VENCIMIENTOS	SMALLINT
);



CREATE TABLE TIPOS_IVA(
	CODIGO		SMALLINT 	NOT NULL PRIMARY KEY,
	DESCRIPCION	VARCHAR(15) 	NOT NULL,
	PORC_IVA	DECIMAL	 	NOT NULL,
	PORC_RE		DECIMAL		NOT NULL
);

CREATE TABLE DPERSONALES(
	CODIGO		INTEGER	NOT NULL PRIMARY KEY,
	POTENCIAL	CHAR,
	FECHA_ALTA	TIMESTAMP,
	CODIGO2		VARCHAR(15),
	NOMBRE		VARCHAR(40),
	RAZON		VARCHAR(40),
	DIRECCION1	VARCHAR(30),
	DIRECCION2	VARCHAR(30),
	POBLACION	VARCHAR(30),
	PROVINCIA	VARCHAR(30),
	CONTACTO	VARCHAR(40),
	E_MAIL		VARCHAR(40),
	WEB		VARCHAR(40),
	NIF		VARCHAR(15),
	TELEFONO1	VARCHAR(13),
	TELEFONO2	VARCHAR(13),
	FAX		VARCHAR(13),
	COD_PAIS	VARCHAR(3),
	COD_POSTAL	VARCHAR(10),
	FECHA_BAJA	DATE,
	FECHA_MODIF	TIMESTAMP,
	RUTA		VARCHAR(5),
	ZONA		VARCHAR(5),
	DIA_VISITA	VARCHAR(20),
	TIPO		VARCHAR(5),
	ACTIVIDAD	VARCHAR(5),
	AGENTE		INTEGER,
	FORMA_PAGO	VARCHAR(5),
	IVA_FIJO	SMALLINT,
	IRPF		SMALLINT
);	


CREATE TABLE DBANCARIOS(
	CODIGO		INTEGER	NOT NULL,
	DIVISA		VARCHAR(3),
	TARIFA		SMALLINT,
	DIA_PAGO1	SMALLINT,
	DIA_PAGO2	SMALLINT,
	DIA_PAGO3	SMALLINT,
	MES_NO_PAGO	SMALLINT,
	DTO_1		DECIMAL,
	DTO_2		DECIMAL,
	DTO_PP		DECIMAL,
	INCREMENTO	DECIMAL	,
	PORTES		VARCHAR(1),
	RIESG_SOLICITA 	DECIMAL	,
	RIESGO_CONCED	DECIMAL	,
	RIESGO_DISP	DECIMAL	,
	REC_EQUI	CHAR,
	BANCO		VARCHAR(30),
	ENTIDAD		VARCHAR(10),
	SUCURSAL	VARCHAR(10),
	CB		VARCHAR(10),
	CC		VARCHAR(10),
	OBSERVACIONES	BLOB SUB_TYPE 1,
	AVISO		BLOB SUB_TYPE 1,
	FOREIGN KEY (CODIGO) REFERENCES DPERSONALES(CODIGO) ON UPDATE CASCADE ON DELETE CASCADE
	
);
CREATE TABLE ARTICULOS(
	AVISO		BLOB SUB_TYPE 1,
	CODIGO		VARCHAR(20)	NOT NULL PRIMARY KEY,
	CODIGO2		VARCHAR(20),
	DTO_1		DECIMAL(15,4),
	DTO_2		DECIMAL(15,4),
	DTO_3		DECIMAL(15,4),
	DTO_4		DECIMAL(15,4),
	DTO_5		DECIMAL(15,4),
	ESC_1_DESDE	DECIMAL(15,4)		NOT NULL,
	ESC_1_HASTA	DECIMAL(15,4)		NOT NULL,
	ESC_2_DESDE	DECIMAL(15,4)		NOT NULL,
	ESC_2_HASTA	DECIMAL(15,4)		NOT NULL,
	ESC_3_DESDE	DECIMAL(15,4)		NOT NULL,
	ESC_3_HASTA	DECIMAL(15,4)		NOT NULL,
	ESC_4_DESDE	DECIMAL(15,4)		NOT NULL,
	ESC_4_HASTA	DECIMAL(15,4)		NOT NULL,
	ESC_5_DESDE	DECIMAL(15,4)		NOT NULL,
	ESC_5_HASTA	DECIMAL	(15,4)	NOT NULL,
	FAMILIA		VARCHAR(5),
	FECHA_MODI 	DATE,
	MARCA		VARCHAR(20),
	NOMBRE		VARCHAR(50)	NOT NULL,
	OBSERVACIONES	BLOB SUB_TYPE 1,
	PENDIENTE_REC	DECIMAL		NOT NULL,
	PENDIENTE_SERVIR	DECIMAL	NOT NULL,
	PVP_1		DECIMAL(15,4),
	PVP_2		DECIMAL(15,4),
	PVP_3		DECIMAL(15,4),
	PVP_4		DECIMAL(15,4),
	PVP_5		DECIMAL(15,4),
	SECCION		VARCHAR(5),
	SUBFAMILIA	VARCHAR(5),
	TIPO_IVA	SMALLINT,
	UNIDADES_BULTO	DECIMAL(15,4)		NOT NULL,
	STOCK		DECIMAL(15,4),
	FECHA_PEND_REC	DATE,
	FECHA_BAJA	DATE	
);	
CREATE TABLE RUTAS_VENTA(
	RUTA		VARCHAR(5) NOT NULL,
	CODCLIENTE	INTEGER NOT NULL,
	CLIENTE		VARCHAR(40),
	VENDEDOR	INTEGER	NOT NULL,
	DIA		INTEGER NOT NULL,
	LINEA		INTEGER NOT NULL,
	FOREIGN KEY (RUTA) REFERENCES RUTAS(CODIGO) ON UPDATE CASCADE ON DELETE CASCADE,
	FOREIGN KEY (VENDEDOR) REFERENCES AGENTES(CODIGO) ON UPDATE CASCADE ON DELETE CASCADE,
	FOREIGN KEY (CODCLIENTE) REFERENCES DPERSONALES(CODIGO) ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE CABECERA_PEDIDO(
	NUMERO_CABECERA		INTEGER 	NOT NULL ,
	SERIE			VARCHAR(5)	NOT NULL ,
	ALBARAN			CHAR,
	ANYO			VARCHAR(5),
	Clase			CHAR,
	Codigo_cliente		INTEGER 	NOT NULL,
	Dto_1			DECIMAL,
	Dto_2			DECIMAL,
	Dto_pp			DECIMAL,
	FECHA			TIMESTAMP,		
	observaciones		BLOB SUB_TYPE 1,

	PRIMARY KEY ( NUMERO_CABECERA, SERIE ),
	FOREIGN KEY (serie) REFERENCES 
		AGENTES(serie) ON UPDATE CASCADE ON DELETE CASCADE,
	FOREIGN KEY (Codigo_cliente) 
		REFERENCES DPERSONALES(CODIGO) ON UPDATE CASCADE ON DELETE CASCADE	
);
	

CREATE TABLE LINEA_PEDIDO (
	NUMERO_LINEA		INTEGER 	NOT NULL,
	NUMERO_CABECERA		INTEGER		NOT NULL,
	SERIE			VARCHAR(5)	NOT NULL ,	
	CODIGO_ARTICULO		VARCHAR(20),	
	TARIFAS			SMALLINT,
	CAJAS    		DECIMAL,
	UNIDADES   		DECIMAL,
	Dto_1			DECIMAL, 
	Dto_2			DECIMAL,
	Dto_3			DECIMAL,
	observaciones		BLOB SUB_TYPE 1,

	PRIMARY KEY ( NUMERO_LINEA,NUMERO_CABECERA,SERIE),
	FOREIGN KEY (NUMERO_CABECERA,SERIE) REFERENCES 
		CABECERA_PEDIDO(NUMERO_CABECERA,SERIE) ON UPDATE CASCADE ON DELETE CASCADE
);
CREATE TABLE INCIDENCIAS(
	NUMERO		INTEGER	NOT NULL PRIMARY KEY,
	CODIGO		VARCHAR(5) NOT NULL ,
	COD_CLIENTE	INTEGER	NOT NULL ,
	OBSERVACIONES	BLOB SUB_TYPE 1,
	FECHA		TIMESTAMP,

	FOREIGN KEY (CODIGO) REFERENCES TIPOS_INCIDENCIAS(CODIGO) ON UPDATE CASCADE ON DELETE CASCADE,
	FOREIGN KEY (COD_CLIENTE) REFERENCES
		DPERSONALES(CODIGO) ON UPDATE CASCADE ON DELETE CASCADE
);

/* Generador de ids para datos personales 
CREATE GENERATOR insertar_Incidencias;


/* trigger que autoincrementa el codigo en cientes cuando no se especifica */
SET TERM || ;
CREATE TRIGGER "insertar_Incidencias" FOR "incidencias"
ACTIVE 
BEFORE INSERT 
POSITION 0
AS
BEGIN
 IF (NEW.NUMERO IS NULL) THEN
	BEGIN
  		NEW.NUMERO = GEN_ID(gen_incidencias,1);
	END
END ||
SET TERM ; ||
























/* Generador de ids para datos personales 
CREATE GENERATOR gen_DPERSONALES;


/* trigger que autoincrementa el codigo en cientes cuando no se especifica */
SET TERM || ;
CREATE TRIGGER "insertar_DPERSONALES" FOR "DPERSONALES"
ACTIVE 
BEFORE INSERT 
POSITION 0
AS
BEGIN
 IF (NEW.CODIGO IS NULL) THEN
	BEGIN
  		NEW.CODIGO = GEN_ID(gen_DPERSONALES,1);
	END
END ||
SET TERM ; ||
 
*/